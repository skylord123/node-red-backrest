<script type="text/javascript">
    (function() {

        const apiDetails = {
            "/v1.Backrest/GetOperations": {
                label: "Get Operations",
                description: "Fetch the list of operations from the Backrest server.",
                input: {
                    type: "object",
                    example: {
                        "lastN": 1000,
                        "selector": {
                            "repoId": "repo-id"
                        }
                    }
                },
                output: {
                    description: "Array of operations with details (type, status, timestamps)."
                }
            },
            "/v1.Backrest/Cancel": {
                label: "Cancel Operation",
                description: "Attempt to cancel an operation by ID.",
                input: {
                    type: "object",
                    example: {
                        "value": 12345
                    }
                },
                output: {
                    description: "No response body, operation cancellation requested."
                }
            },
            "/v1.Backrest/GetDownloadURL": {
                label: "Get Download URL",
                description: "Retrieve a signed URL for downloading forget operation results.",
                input: {
                    type: "object",
                    example: {
                        "value": 12345
                    }
                },
                output: {
                    description: "String containing the signed download URL."
                }
            },
            "/v1.Backrest/Backup": {
                label: "Start Backup",
                description: "Schedule a backup operation.",
                input: {
                    type: "object",
                    example: {
                        "value": "plan-id"
                    }
                },
                output: {
                    description: "No response body, indicates the operation was successfully enqueued."
                }
            },
            "/v1.Backrest/Restore": {
                label: "Restore Snapshot",
                description: "Schedule a restore operation for a snapshot.",
                input: {
                    type: "object",
                    example: {
                        "planId": "plan-id",
                        "repoId": "repo-id",
                        "snapshotId": "snapshot-id",
                        "path": "/source/path",
                        "target": "/restore/path"
                    }
                },
                output: {
                    description: "No response body, operation successfully enqueued."
                }
            },
            "/v1.Backrest/Forget": {
                label: "Forget Snapshot",
                description: "Schedule a forget operation for snapshots.",
                input: {
                    type: "object",
                    example: {
                        "repoId": "repo-id",
                        "planId": "plan-id",
                        "snapshotId": "snap-id"
                    }
                },
                output: {
                    description: "No response body, operation successfully enqueued."
                }
            },
            "/v1.Backrest/DoRepoTask": {
                label: "Run Repository Task",
                description: "Schedule a repository task (e.g., prune, stats).",
                input: {
                    type: "object",
                    example: {
                        "repoId": "repo-id",
                        "task": "TASK_PRUNE"
                    }
                },
                output: {
                    description: "No response body, task successfully enqueued."
                }
            },
            "/v1.Backrest/RunCommand": {
                label: "Run Custom Restic Command",
                description: "Execute a custom Restic command on a repository.",
                input: {
                    type: "object",
                    example: {
                        "repoId": "repo-id",
                        "command": "restic-command"
                    }
                },
                output: {
                    description: "Operation ID of the executed command."
                }
            },
            "/v1.Backrest/ListSnapshots": {
                label: "List Snapshots",
                description: "List snapshots for a repository or plan.",
                input: {
                    type: "object",
                    example: {
                        "repoId": "repo-id",
                        "planId": "plan-id"
                    }
                },
                output: {
                    description: "Array of snapshots with metadata."
                }
            },
            "/v1.Backrest/ListSnapshotFiles": {
                label: "List Files in Snapshot",
                description: "List files within a snapshot at a specific path.",
                input: {
                    type: "object",
                    example: {
                        "repoId": "repository-id",
                        "snapshotId": "snapshot-id",
                        "path": "target/path"
                    }
                },
                output: {
                    description: "Object containing path and file entries."
                }
            },
            "/v1.Backrest/GetConfig": {
                label: "Get Config",
                description: "Retrieve the Backrest server configuration.",
                input: {
                    type: "none",
                    example: null
                },
                output: {
                    description: "The configuration object describing the Backrest setup."
                }
            },
            "/v1.Backrest/SetConfig": {
                label: "Set Config",
                description: "Update the Backrest server configuration.",
                input: {
                    type: "object",
                    example: {
                        "configKey": "configValue"
                    }
                },
                output: {
                    description: "The updated configuration object."
                }
            },
            "/v1.Backrest/GetSummaryDashboard": {
                label: "Get Summary Dashboard",
                description: "Retrieve summary data for the dashboard view.",
                input: {
                    type: "none",
                    example: null
                },
                output: {
                    description: "Summary metrics for the dashboard."
                }
            },
            "/v1.Backrest/CheckRepoExists": {
                label: "Check if Repository Exists",
                description: "Check if a repository exists on the Backrest server.",
                input: {
                    type: "object",
                    example: {
                        "id": "repo-id"
                    }
                },
                output: {
                    description: "Boolean indicating if the repository exists."
                }
            },
            "/v1.Backrest/AddRepo": {
                label: "Add Repository",
                description: "Add a new repository to Backrest.",
                input: {
                    type: "object",
                    example: {
                        "id": "repo-id",
                        "path": "/path/to/repo"
                    }
                },
                output: {
                    description: "Updated configuration including the new repository."
                }
            },
            "/v1.Backrest/ClearHistory": {
                label: "Clear Operation History",
                description: "Clear operation history.",
                input: {
                    type: "object",
                    example: {
                        "selector": { "planId": "plan-id" },
                        "onlyFailed": true
                    }
                },
                output: {
                    description: "No response body, history successfully cleared."
                }
            },
            "/v1.Backrest/PathAutocomplete": {
                label: "Path Autocomplete",
                description: "Autocomplete paths based on the given input.",
                input: {
                    type: "object",
                    example: {
                        "value": "/base/path"
                    }
                },
                output: {
                    description: "Array of autocomplete suggestions."
                }
            }
        };

        /**
         * Register our Node
         */
        RED.nodes.registerType('backrest-api', {
            category: 'backrest',
            color: "#00e4d3",
            defaults: {
                name: { value: "" },
                config: { type: "backrest-config", required: true },
                endpoint: { value: "/v1.Backrest/GetOperations" },
                inputType: { value: "msg", required: false },
                inputValue: { value: "payload", required: false }
            },
            inputs: 1,
            outputs: 1,
            icon: "node-red-contrib-backrest-logo.png",
            paletteLabel: "API",
            /**
             * Dynamically sets the node label:
             *  - If user manually provided `this.name`, use that
             *  - Otherwise, use the `label` from `apiDetails[this.endpoint]`
             *  - Fallback to "Backrest API" if none found
             */
            label: function () {
                if (this.name) {
                    return this.name;
                }
                const details = apiDetails[this.endpoint];
                if (details && details.label) {
                    return details.label;
                }
                return "API";
            },

            oneditprepare: function () {

                // 1) Clear any pre-existing <option> elements (from the HTML template)
                // 2) Dynamically build them from our `apiDetails` object
                const $endpointSelect = $("#node-input-endpoint").empty();
                Object.entries(apiDetails).forEach(([endpoint, info]) => {
                    $endpointSelect.append(
                        $("<option>").val(endpoint).text(info.label)
                    );
                });

                // Set the select box to the current endpoint
                $endpointSelect.val(this.endpoint);

                // Initialize TypedInput for Input Configuration
                $("#node-input-input").typedInput({
                    types: ['msg', 'flow', 'global', 'jsonata', 'json']
                })
                    .typedInput('value', this.inputValue || "payload")
                    .typedInput('type', this.inputType || "msg");

                // Handle updating the description when the user changes endpoints
                $endpointSelect.on("change", updateAPIDescriptionAndToggleInput);
                updateAPIDescriptionAndToggleInput(); // Initial update on load

                function updateAPIDescriptionAndToggleInput() {
                    const selectedAPI = $endpointSelect.val();
                    const apiInfo = apiDetails[selectedAPI];
                    if (apiInfo) {
                        let inputExampleHTML = '';
                        if (apiInfo.input.type !== "none" && apiInfo.input.example) {
                            inputExampleHTML = `<pre>${JSON.stringify(apiInfo.input.example, null, 4)}</pre>`;
                        } else if (apiInfo.input.type === "none") {
                            inputExampleHTML = `<p><strong>No input required.</strong></p>`;
                        }

                        $("#selected-api-description").html(`
                        <p><strong>Description:</strong> ${apiInfo.description}</p>
                        <div><strong>Input Example:</strong> ${inputExampleHTML}</div>
                        <div><strong>Output Example:</strong> ${apiInfo.output.description}</div>
                    `);

                        // Toggle input config row depending on input type
                        if (apiInfo.input.type === "none") {
                            $("#input-config-row").hide();
                        } else {
                            $("#input-config-row").show();
                        }
                    }
                }
            },

            oneditsave: function () {
                // Save TypedInput configuration
                this.inputType = $("#node-input-input").typedInput('type');
                this.inputValue = $("#node-input-input").typedInput('value');
            }
        });

    })();
</script>


<script type="text/html" data-template-name="backrest-api">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Node Name" />
    </div>
    <div class="form-row">
        <label for="node-input-config"><i class="fa fa-cog"></i> Backrest Server</label>
        <input type="text" id="node-input-config" />
    </div>
    <div class="form-row">
        <label for="node-input-endpoint"><i class="fa fa-path"></i> API Endpoint</label>
        <select id="node-input-endpoint"></select>
    </div>
    <div class="form-row" id="input-config-row">
        <label for="node-input-input"><i class="fa fa-input"></i> Input</label>
        <input type="text" id="node-input-input" />
    </div>
    <div class="form-row" id="api-description">
        <div style="font-weight:800;"><i class="fa fa-info-circle"></i> Selected API Info</div>
        <div id="selected-api-description" style="margin-top:5px;"></div>
    </div>
</script>

<script type="text/html" data-help-name="backrest-api">
    <p>Makes API calls to a Backrest server. This node allows you to interact with various Backrest API endpoints for managing backups, restores, and other operations.</p>

    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt class="optional">
            msg.payload <span class="property-type">object | null</span>
        </dt>
        <dd>Input data for the API endpoint. The structure depends on the selected endpoint. If the endpoint requires no input, this can be omitted.</dd>
    </dl>

    <h3>Properties</h3>
    <dl class="message-properties">
        <dt>Backrest Server
            <span class="property-type">config</span>
        </dt>
        <dd>Configuration for connecting to the Backrest server.</dd>

        <dt>API Endpoint
            <span class="property-type">select</span>
        </dt>
        <dd>The Backrest API endpoint to call. Each endpoint has specific input requirements and output formats.</dd>

        <dt class="optional">Input
            <span class="property-type">msg | flow | global | json</span>
        </dt>
        <dd>Property that contains the input data for the API call. Only shown for endpoints that accept input.</dd>
    </dl>

    <h3>Outputs</h3>
    <dl class="message-properties">
        <dt>
            msg.payload <span class="property-type">object | null</span>
        </dt>
        <dd>The response from the Backrest server. Structure varies by endpoint.</dd>

        <dt>
            msg.error <span class="property-type">string</span>
        </dt>
        <dd>Error message if the API call fails.</dd>
    </dl>

    <h3>Details</h3>
    <p>This node provides access to the following Backrest API endpoints:</p>
    <ul>
        <li><code>Get Operations</code> - Fetch the list of operations from the server</li>
        <li><code>Cancel Operation</code> - Attempt to cancel a running operation</li>
        <li><code>Get Download URL</code> - Get a signed URL for downloading operation results</li>
        <li><code>Start Backup</code> - Schedule a new backup operation</li>
        <li><code>Restore Snapshot</code> - Schedule a restore operation</li>
        <li><code>Forget Snapshot</code> - Schedule a forget operation</li>
        <li><code>Run Repository Task</code> - Execute repository maintenance tasks</li>
        <li><code>List Snapshots</code> - List available snapshots</li>
        <li><code>List Files in Snapshot</code> - Browse files within a snapshot</li>
        <li><code>Get/Set Config</code> - Manage server configuration</li>
        <li><code>Get Summary Dashboard</code> - Retrieve system overview</li>
    </ul>

    <h3>References</h3>
    <ul>
        <li><a href="https://restic.net/">Restic Documentation</a> - Learn more about the underlying backup tool</li>
    </ul>
</script>