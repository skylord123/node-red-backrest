<script type="text/javascript">
    RED.nodes.registerType('backrest-query', {
        category: 'function',
        color: "#a6bbcf",
        defaults: {
            name: { value: "" },
            config: { type: "backrest-config", required: true },
            endpoint: { value: "/v1.Backrest/GetOperations" },
            inputType: { value: "msg", required: false },
            inputValue: { value: "payload", required: false }
        },
        inputs: 1,
        outputs: 1,
        icon: "database.png",
        label: function () {
            return this.name || "Backrest Query";
        },
        oneditprepare: function () {
            const apiDetails = {
                "/v1.Backrest/GetOperations": {
                    description: "Fetch the list of operations from the Backrest server.",
                    input: {
                        type: "object",
                        example: {
                            "lastN": 1000,               // Number of recent operations to retrieve
                            "selector": {
                                "repoId": "repo-id"      // Repository identifier
                            }
                        },
                    },
                    output: {
                        description: "Array of operations with their details (e.g., type, status)."
                    }
                },
                "/v1.Backrest/GetConfig": {
                    description: "Retrieve the Backrest server configuration.",
                    input: {
                        type: "none",
                        example: null // No input required
                    },
                    output: {
                        description: "The configuration object describing the Backrest setup."
                    }
                },
                "/v1.Backrest/ListSnapshotFiles": {
                    description: "List files within a snapshot at a specific path.",
                    input: {
                        type: "object",
                        example: {
                            "repoId": "repository-id",       // Repository identifier
                            "snapshotId": "snapshot-id",     // Snapshot identifier
                            "path": "target/path"            // Path to list files for
                        }
                    },
                    output: {
                        description: "Returns the path queried and an array of file entries (name, type, size, etc.)."
                    }
                }
            };

            // Initialize TypedInput for Input Configuration
            $("#node-input-input").typedInput({
                types: ['msg', 'flow', 'global', 'jsonata', 'json']
            })
                .typedInput('value', this.inputValue || "payload")
                .typedInput('type', this.inputType || "msg");

            // Update API details and toggle input config visibility when endpoint changes
            $("#node-input-endpoint").on("change", updateAPIDescriptionAndToggleInput);
            updateAPIDescriptionAndToggleInput(); // Initial update on load

            function updateAPIDescriptionAndToggleInput() {
                const selectedAPI = $("#node-input-endpoint").val();
                const apiInfo = apiDetails[selectedAPI];
                if (apiInfo) {
                    let inputExampleHTML = '';
                    if (apiInfo.input.type !== "none" && apiInfo.input.example) {
                        inputExampleHTML = `<pre>${JSON.stringify(apiInfo.input.example, null, 4)}</pre>`;
                    } else if (apiInfo.input.type === "none") {
                        inputExampleHTML = `<p><strong>No input required.</strong></p>`;
                    }

                    $("#selected-api-description").html(`
                        <p><strong>Description:</strong> ${apiInfo.description}</p>
                        <div><strong>Input Example:</strong> ${inputExampleHTML}</div>
                        <div><strong>Output Example:</strong> ${apiInfo.output.description}</div>
                    `);

                    // Toggle the visibility of the input config row based on input type
                    if (apiInfo.input.type === "none") {
                        $("#input-config-row").hide();
                    } else {
                        $("#input-config-row").show();
                    }
                }
            }
        },
        oneditsave: function () {
            // Save TypedInput configuration
            this.inputType = $("#node-input-input").typedInput('type');
            this.inputValue = $("#node-input-input").typedInput('value');
        }
    });
</script>

<script type="text/html" data-template-name="backrest-query">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Node Name" />
    </div>
    <div class="form-row">
        <label for="node-input-config"><i class="fa fa-cog"></i> Backrest Server</label>
        <input type="text" id="node-input-config" />
    </div>
    <div class="form-row">
        <label for="node-input-endpoint"><i class="fa fa-path"></i> API Endpoint</label>
        <select id="node-input-endpoint">
            <option value="/v1.Backrest/GetConfig">Get Config</option>
            <option value="/v1.Backrest/GetOperations">Get Operations</option>
            <option value="/v1.Backrest/ListSnapshotFiles">List Files in Snapshot</option>
        </select>
    </div>
    <div class="form-row" id="input-config-row">
        <label for="node-input-input"><i class="fa fa-input"></i> Input</label>
        <input type="text" id="node-input-input" />
    </div>
    <div class="form-row" id="api-description">
        <label><i class="fa fa-info-circle"></i> Selected API Info</label>
        <div id="selected-api-description" style="margin-top:5px;"></div>
    </div>
</script>
